apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: qlens-chaos-fault-injection
  namespace: quantum-system
  labels:
    app.kubernetes.io/name: qlens
    app.kubernetes.io/component: chaos-engineering
spec:
  workloadSelector:
    labels:
      app.kubernetes.io/name: qlens-router
  configPatches:
  - applyTo: HTTP_ROUTE
    match:
      context: SIDECAR_INBOUND
      routeConfiguration:
        vhost:
          name: "inbound|http|8106"
    patch:
      operation: MERGE
      value:
        fault:
          delay:
            percentage:
              value: 0.01  # 0.01% of requests in production
            fixed_delay: 5s
          abort:
            percentage:
              value: 0.001  # 0.001% of requests
            http_status: 503

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: qlens-chaos-config
  namespace: quantum-system
  labels:
    app.kubernetes.io/name: qlens
    app.kubernetes.io/component: chaos-engineering
data:
  chaos_rules.yaml: |
    chaos_experiments:
      - name: "network_delay"
        enabled: true
        probability: 0.001
        delay_ms: 5000
        target_services: ["qlens-router"]
        
      - name: "service_failure"
        enabled: true
        probability: 0.0001
        http_status: 503
        target_services: ["qlens-router", "qlens-cache"]
        
      - name: "dependency_timeout"
        enabled: true
        probability: 0.001
        timeout_ms: 1000
        target_operations: ["external_api_calls"]
        
    feature_flags:
      chaos_engineering_enabled: true
      chaos_max_failure_rate: 0.01
      chaos_recovery_time_ms: 30000

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: qlens-chaos-testing
  namespace: quantum-system
  labels:
    app.kubernetes.io/name: qlens
    app.kubernetes.io/component: chaos-engineering
spec:
  hosts:
  - qlens-router.quantum-system.svc.cluster.local
  http:
  - match:
    - headers:
        x-chaos-test:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 50  # 50% of chaos test traffic gets delayed
        fixedDelay: 3s
      abort:
        percentage:
          value: 10  # 10% of chaos test traffic fails
        httpStatus: 503
    route:
    - destination:
        host: qlens-router.quantum-system.svc.cluster.local
        port:
          number: 8106
    timeout: 30s
    
  # Normal traffic (without chaos header)
  - route:
    - destination:
        host: qlens-router.quantum-system.svc.cluster.local
        port:
          number: 8106
    timeout: 60s

---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: qlens-circuit-breaker
  namespace: quantum-system
  labels:
    app.kubernetes.io/name: qlens
    app.kubernetes.io/component: circuit-breaker
spec:
  workloadSelector:
    labels:
      app.kubernetes.io/name: qlens-router
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.fault
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.fault.v3.HTTPFault
          max_active_faults: 100
          response_rate_limit:
            fixed_limit:
              limit_kbps: 1000
          delay:
            percentage:
              value: 0.1
            fixed_delay: 0.1s
          upstream_cluster: "outbound|443||api.openai.com"